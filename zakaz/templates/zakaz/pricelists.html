{% extends 'base.html' %}

{% load static %}

{% block content %}
    <div id="id_app" class="h-100"></div>
{% endblock content %}

{% block js_libs %}
    {{block.super}}
    <script src="{% static 'js/vue3522.global.min.js' %}"></script>
    <script src="{% static 'fp.js' %}"></script>
{% endblock js_libs %}

{% block js %}
    <template id="id_theme_template">
        <div class="bg-white border rounded p-2">
            <h6>[[ theme.ru ]] <i class="text-black-50 me-2">([[ theme.key ]])</i>
                <button v-if="!locked" @click="$emit('remove')" class="btn btn-outline-danger border-0 p-0"><i class="bi bi-dash-lg"></i></button>
            </h6>

            <div class="mb-1">
                <label class="d-flex align-items-center">имя: <input type="text" v-model="theme.ru" class="flex-grow-1"></label>
            </div>

            <div v-if="!locked" class="mb-1">
                <label class="d-flex align-items-center">ID: <input type="text" v-model="theme.key" class="flex-grow-1"></label>
            </div>

            <div class="mb-1">
                <label class="d-flex align-items-center">style: <textarea v-model="theme.blank_img_style" class="flex-grow-1"></textarea></label>
            </div>

            <ul class="d-flex flex-wrap row-gap-2 list-unstyled mb-0 user-select-none rounded p-1"
                :class="{'bg-success-subtle': dragging}"
                @dragleave.stop.capture.prevent="enter(null)"
                @dragenter.stop.prevent="enter(theme.formats.length)"
                @dragover.stop.prevent="enter(theme.formats.length)"
                @drop="drop(theme.formats.length)"
            >
                <li v-for="(f, index) in theme.formats" :key="f"
                    @dragenter.stop.prevent="enter(index)"
                    @dragover.stop.prevent="enter(index)"
                    @dragleave.stop.prevent
                    @drop="drop(index)"
                >
                    <span class="mx-2 border" :class="{'opacity-0': !dragging, 'border-primary': index == hlindex}"></span>
                    <span class="border rounded p-1 shadow-sm cursor-pointer bg-primary-subtle"
                        :class="{'bg-danger-subtle': !keys.has(f), 'opacity-50': dragindex == index}"
                        draggable="true"
                        @dragstart="drag(index)"
                        @dragend="end"
                    >[[ f ]]</span>
                </li>

                <li @dragenter.prevent="enter(theme.formats.length)"
                    @dragover.prevent
                    @dragleave.prevent
                    @drop="drop(theme.formats.length)"
                >
                    <span class="mx-2 border"
                        :class="{'opacity-0': !dragging, 'border-primary': theme.formats.length == hlindex}"
                    ></span>
                    <span v-if="theme.formats.length > 1" class="border rounded p-1 shadow-sm cursor-pointer bg-secondary-subtle text-danger"
                        @click="remove_all"
                    ><i class="bi bi-dash-lg me-1"></i>
                        Все
                    </span>
                </li>
            </ul>

            <ul class="d-flex flex-wrap row-gap-2 list-unstyled mb-0 mt-4 user-select-none rounded p-1"
                style="min-height:32px;"
                :class="{'bg-danger-subtle': dragging}"
                @dragenter.prevent
                @dragover.prevent
                @dragleave.prevent
                @drop="remove"
            >
                <li v-for="(f, index) in unused_formats" :key="f" class="pe-2">
                    <span class="border rounded p-1 shadow-sm cursor-pointer bg-success-subtle"
                        draggable="true"
                        @dragstart="drag_add(index)"
                        @dragend="end"
                    >[[ f ]]</span>
                </li>
                <li v-if="unused_formats.length">
                    <span class="border rounded p-1 shadow-sm cursor-pointer bg-secondary-subtle text-success"
                        @click="add_all"
                    ><i class="bi bi-plus-lg me-1"></i>
                        Все
                    </span>
                </li>
            </ul>
        </div>
    </template>
    <script>
        const Theme = {
            template: '#id_theme_template',
            emits: ['remove'],
            props: {theme: Object, formats: Array, locked: Boolean},
            data() {
                return {
                    dragging: false,
                    dragindex: null,
                    addindex: null,
                    hlindex: null,
                    fmt: null,
                }
            },
            computed: {
                keys() {
                    return new Set(this.formats.map(f => f.key))
                },
                unused_formats() {
                    return [...this.keys.difference(new Set(this.theme.formats))].toSorted()
                },
            },
            methods: {
                drag(index) {
                    this.dragging = true
                    this.dragindex = index
                    this.fmt = this.theme.formats[index]
                },
                drag_add(index) {
                    this.dragging = true
                    this.addindex = index
                    this.fmt = this.unused_formats[index]
                },
                enter(index) {
                    if (!this.dragging) {return}
                    this.hlindex = index
                },
                drop(index) {
                    if (!this.dragging) {return}

                    if (Number.isInteger(this.addindex)) {
                        this.theme.formats.splice(index, 0, this.fmt)
                    } else if (Number.isInteger(this.dragindex)) {
                        const i = index > this.dragindex ? index - 1 : index
                        this.theme.formats.splice(this.dragindex, 1)
                        this.theme.formats.splice(i, 0, this.fmt)
                    }
                    this.fmt = null
                    this.dragindex = null
                    this.hlindex = null
                    this.addindex = null
                },
                remove() {
                    if (!this.dragging || !Number.isInteger(this.dragindex)) {return}
                    this.theme.formats.splice(this.dragindex, 1)
                    this.fmt = null
                    this.dragindex = null
                    this.hlindex = null
                    this.addindex = null
                },
                end() {
                    this.dragging = false
                },
                add_all() {
                    const all = [...this.unused_formats]
                    all.forEach(f => this.theme.formats.push(f))
                },
                remove_all() {
                    this.theme.formats = []
                },
            },
        }
    </script>


    <template id="id_price_template">
        <h5>Прайс "[[ price.name ]]"
            <i class="text-black-50">([[ price.id ]])</i>
        </h5>


        <div class="border rounded bg-white mb-4 d-flex justify-content-between align-items-center">
            <label class="p-2 py-1">
                имя: <input type="text" v-model="price.name">
            </label>

            <div class="px-2">
                <button @click="$emit('copy')" class="btn btn-sm btn-outline-primary"><i class="bi bi-copy"></i> Копировать</button>
            </div>
        </div>

        <h6>Форматы</h6>
        <div class="border rounded bg-white mb-4">
            <div v-for="format in sorted_formats" :key="format.key" class="border-bottom p-2 py-1 d-flex justify-content-between align-items-center" :class="[selected_format && selected_format.key == format.key ? 'border-primary bg-primary-subtle' : '']" @click="select_format(format.key)">
                <div>[[ format.ru ]] <i class="text-black-50">([[ format.key ]])</i> </div>
                <div class="text-black-50">[[ format.dir ]]<span v-if="format.en">/[[ format.en ]]</span></div>
                <div class="text-nowrap ms-2">
                    [[ format.price ]]
                    <button v-if="!price.locked" @click.stop="delete_format(format.key)" class="btn btn-sm btn-outline-danger border-0 p-0">
                        <i class="bi bi-dash-lg"></i>
                    </button>
                </div>
            </div>

            <div v-if="!price.locked || selected_format" class="p-2 py-1 d-flex flex-wrap gap-1">
                <label>имя:<input type="text" v-model="edit_format.ru" required></label>
                <label v-if="!price.locked">ID:<input type="text" v-model="edit_format.key" required></label>
                <label>папка:<input type="text" v-model="edit_format.dir" required></label>
                <label>суффикс:<input type="text" v-model="edit_format.en"></label>
                <label v-if="!price.locked">цена:<input type="text" v-model.number="edit_format.price" required></label>
                <button @click="save_format" class="btn btn-sm btn-outline-success p-1"><i :class="selected_format ? 'bi bi-check-lg' : 'bi bi-plus-lg'"></i></button>
            </div>
        </div>


        <h6>Темы <button v-if="!price.locked" @click="add_theme" class="btn btn-outline-secondary border-0 p-1 py-0"><i class="bi bi-plus-lg"></i></button></h6>
        <div class="row">
            <div v-for="(theme, index) in price.themes" :key="index" class="col-6 mb-4">
                <theme :theme="theme" :formats="sorted_formats" :locked="price.locked" @remove="remove_theme(index)">
            </div>
        </div>

        <h6>Бонус</h6>
        <div class="border rounded bg-white mb-4 p-2">
            <div class="mb-2"><label class="d-flex align-items-center">
                <span>Сумма</span>
                <input class="flex-grow-1 ms-2" type="number" v-model="price.bonus.sum">
            </label></div>

            <div class="mb-2"><label class="d-flex align-items-center">
                <span>Текст</span>
                <input class="flex-grow-1 ms-2" type="text" v-model="price.bonus.text">
            </label></div>

            <div class="mb-2"><label class="d-flex align-items-center">
                <span>Если набрана</span>
                <input class="flex-grow-1 ms-2" type="text" v-model="price.bonus.success">
            </label></div>
        </div>

        <Teleport :to="`#id_menu_price_${index}`">
            <button class="btn btn-light border w-100">
                [[ price.name ]]
                <span v-if="dirty" class="ms-2"><i class="bi bi-floppy-fill text-success"></i></span>
            </button>
        </Teleport>

        <Teleport defer to="#id_menu_selected_price">
            <div v-if="dirty" class="mb-2">
                <hr>
                <button @click="save" class="btn btn-outline-success w-100" :class="{'disabled': spin}"><i class="bi bi-floppy-fill"></i> Сохранить</button>
            </div>
        </Teleport>
    </template>

    <script>
        const json_copy = json_value => JSON.parse(JSON.stringify(json_value))
        const Price = {
            template: '#id_price_template',
            props: {price: Object, orig: Object, index: Number},
            emits: ['copy'],
            components: {Theme},
            data() {
                return {
                    selected_format: null,
                    edit_format: {},
                    spin: false,
                }
            },
            computed: {
                dirty() {
                    return !eq(this.price, this.orig)
                },
                sorted_formats() {
                    if (this.price) {
                        return Object.values(this.price.formats).toSorted((a, b) => 
                            a.key.toLowerCase().localeCompare(b.key.toLowerCase())
                        )
                    }
                    return []
                },
            },
            methods: {
                select_format(k) {
                    if (this.selected_format && this.selected_format.key == k) {
                        this.selected_format = null
                    } else {
                        this.selected_format = this.price.formats[k]
                        this.edit_format.ru = this.selected_format.ru
                        this.edit_format.key = this.selected_format.key
                        this.edit_format.dir = this.selected_format.dir
                        this.edit_format.en = this.selected_format.en
                        this.edit_format.price = this.selected_format.price
                    }
                },

                save_format() {
                    if (this.selected_format) {
                        this.selected_format.ru = this.edit_format.ru
                        this.selected_format.key = this.edit_format.key
                        this.selected_format.dir = this.edit_format.dir
                        this.selected_format.en = this.edit_format.en
                        this.selected_format.price = this.edit_format.price
                    } else {
                        const key = this.edit_format.key
                        if (key in this.price.formats) {
                            console.log('format key exists')
                            return
                        }
                        const new_format = {
                            'key': key,
                            'ru': this.edit_format.ru,
                            'dir': this.edit_format.dir,
                            'en': this.edit_format.en,
                            'price': this.edit_format.price,
                        }
                        this.price.formats[key] = new_format
                    }
                },

                delete_format(k) {
                    delete this.price.formats[k]
                },

                add_theme() {
                    if (this.price.themes.find(th => th.key === '')) {return}
                    this.price.themes.push({
                        key: '',
                        ru: '',
                        formats: [],
                        blank_img_style: '',
                        //_can_delete: true,
                    })
                },
                remove_theme(index) {
                    this.price.themes.splice(index, 1)
                },
                save() {
                    //const body = json_copy(this.price)
                    this.spin = true
                    fetch('.', {
                        method: 'post',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{csrf_token}}',
                        },
                        body: JSON.stringify(this.price),
                    }).then(res => res.json()).then(res => {
                        if (res.success) {
                            this.price.id = res.id
                            this.orig.id = res.id
                            this.orig.name = this.price.name
                            this.orig.formats = json_copy(this.price.formats)
                            this.orig.themes = json_copy(this.price.themes)
                            this.orig.bonus = json_copy(this.price.bonus)
                        }
                    }).finally(() => {
                        this.spin = false
                    })
                },
            },
        }
    </script>

    
    <template id="id_main_template">
        <div v-if="loading" class="d-flex justify-content-center">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
        </div>

        <div class="container-fluid h-100">
            <div class="row h-100">
                <div class="col-2 bg-white shadow-sm">
                    <div class="sticky-top">
                        <h5 class="text-center">прайсы</h5>
                        <div v-for="(p, index) in prices" :key="index" :id="`id_menu_price_${index}`" class="mb-2">
                            <template v-if="selected_index !== index">
                                <button @click="select_price(index)" class="btn btn-link w-100">
                                    [[ p.name ]]
                                    <span v-if="!eq(p, orig[index])" class="ms-2 text-success"><i class="bi bi-floppy-fill"></i></span>
                                </button>
                            </template>
                        </div>
                        <div class="mb-2">
                            <button @click="new_price" class="btn btn-outline-success w-100"><i class="bi bi-plus-lg"></i> Новый</button>
                        </div>
                        <div id="id_menu_selected_price" class="mb-2"></div>
                    </div>
                </div>

                <div v-if="selected_price" class="col-10">
                    <Price :price="selected_price" :index="selected_index" :orig="orig[selected_index]" @copy="copy_price"/>
                </div>
            </div>
        </div>
    </template>

    <script>
        ;document.addEventListener('DOMContentLoaded', () => {
            const { ref, onMounted } = Vue

            const App = {
                template: '#id_main_template',
                components: {Price},
                data() {
                    return {
                        loading: false,
                        loaded: false,
                        prices: [],
                        orig: null,
                        selected_price: null,
                        selected_index: null,
                    }
                },
                mounted() { this.load() },
                methods: {
                    eq,
                    load() {
                        this.loading = true
                        fetch('.?format=json').then(res => res.json()).then(res => {
                            if (res.success) {
                                this.prices = structuredClone(res.data)
                                this.orig = res.data
                            }
                        }).finally(() => {
                            this.loading = false
                            this.loaded = true
                        })
                    },

                    select_price(index) {
                        this.selected_price = this.prices[index]
                        this.selected_index = index
                        this.edit_format = {}
                    },

                    copy_price() {
                        const copy = json_copy(this.selected_price)
                        delete copy.id
                        copy.locked = false
                        copy.name = copy.name + " (copy)"
                        this.prices.push(copy)
                        this.orig.push({})
                        this.select_price(this.prices.length - 1)
                    },

                    new_price() {
                        const today = new Date()
                        const price = {
                            name: `${today.getFullYear()}-${today.getMonth() + 1}`,
                            locked: false,
                            formats: {},
                            themes: [],
                            bonus: {sum:0, text: '', success: ''},
                        }
                        this.prices.push(price)
                        this.orig.push({})
                    },
                },
            }

            const app = Vue.createApp(App)
            app.config.compilerOptions.delimiters = ['[[', ']]']
            window.vm = app.mount('#id_app')
        });
    </script>
{% endblock js %}
